@model HomeFinder.Models.ApartmentViewModel
@{
    ViewData["Title"] = "Edit Apartment";
    var initLat = Model.Latitude?.ToString("F6") ?? "41.311081";
    var initLng = Model.Longitude?.ToString("F6") ?? "69.240562";
}

<div class="container mt-4">
    <div class="row">
        <div class="col-md-8">
            <h2>Edit Apartment #@Model.ApartmentId</h2>

            <form asp-action="Edit" method="post" enctype="multipart/form-data">
                @Html.AntiForgeryToken()
                <input type="hidden" asp-for="ApartmentId" />

                <!-- ABOUT -->
                <fieldset class="border p-3 mb-4">
                    <legend class="w-auto px-2">About</legend>
                    <div class="mb-3">
                        <label asp-for="Description" class="form-label">Description</label>
                        <textarea asp-for="Description" class="form-control" rows="4"></textarea>
                        <span asp-validation-for="Description" class="text-danger"></span>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="Price" class="form-label">Price (Uzs)</label>
                                <input asp-for="Price" type="number" class="form-control" min="0" />
                                <span asp-validation-for="Price" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="Size" class="form-label">Size (sq.m)</label>
                                <input asp-for="Size" type="number" class="form-control" min="1" step="0.1" required />
                                <span asp-validation-for="Size" class="text-danger"></span>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label asp-for="Rooms" class="form-label">Number of rooms</label>
                        <input asp-for="Rooms" type="number" class="form-control" min="1" step="1" required />
                        <span asp-validation-for="Rooms" class="text-danger"></span>
                    </div>
                    <div class="mb-3">
                        <label asp-for="ApartmentNumber" class="form-label">Apartment number</label>
                        <input asp-for="ApartmentNumber" class="form-control" />
                        <span asp-validation-for="ApartmentNumber" class="text-danger"></span>
                    </div>
                </fieldset>

                <!-- ADDRESS + MAP -->
                <fieldset class="border p-3 mb-4">
                    <legend class="w-auto px-2">📍 Address & Location</legend>
                    <div class="mb-3">
                        <label class="form-label">🔍 Search address</label>
                        <input type="text" id="addressSearch"
                               class="form-control"
                               value="@($"{Model.StreetAddress}, {Model.City}")" />
                        <small class="form-text text-muted">Enter или кликни на карту для изменения</small>
                    </div>
                    <div id="addressMap" style="height: 350px; border: 2px solid #dee2e6; border-radius: 0.375rem; margin-bottom: 1rem;"></div>

                    <input type="hidden" asp-for="Latitude" id="latitude" value="@initLat" />
                    <input type="hidden" asp-for="Longitude" id="longitude" value="@initLng" />

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="StreetAddress" class="form-label">Street</label>
                                <input asp-for="StreetAddress" class="form-control" />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="BuildingNumber" class="form-label">Building number</label>
                                <input asp-for="BuildingNumber" class="form-control" />
                                <span asp-validation-for="BuildingNumber" class="text-danger"></span>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="District" class="form-label">District</label>
                                <input asp-for="District" class="form-control" />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="City" class="form-label">City</label>
                                <input asp-for="City" class="form-control" value="Tashkent" />
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label asp-for="Region" class="form-label">Region</label>
                        <input asp-for="Region" class="form-control" />
                        <span asp-validation-for="Region" class="text-danger"></span>
                    </div>
                </fieldset>

                <!-- CURRENT PHOTOS -->
                @if (Model.PhotoPaths != null && Model.PhotoPaths.Any())
                {
                    <fieldset class="border p-3 mb-4">
                        <legend class="w-auto px-2">Current photos</legend>
                        <div class="row g-2">
                            @foreach (var photo in Model.PhotoPaths)
                            {
                                <div class="col-md-3">
                                    <img src="@photo" class="img-thumbnail w-100" style="height: 150px; object-fit: cover;" alt="Photo">
                                </div>
                            }
                        </div>
                    </fieldset>
                }

                <!-- NEW PHOTOS -->
                <fieldset class="border p-3 mb-4">
                    <legend class="w-auto px-2">Photos</legend>
                    <div class="mb-3">
                        <label for="photoInput" class="form-label">Upload photos</label>
                        <input type="file"
                               id="photoInput"
                               name="Photos"
                               multiple
                               accept=".jpg,.jpeg,.png"
                               class="form-control" />
                        <div class="form-text">JPG, PNG | Max 5MB per file | Multiple OK</div>
                    </div>
                    <div id="photoPreview" class="row g-2"></div>
                </fieldset>

                <div class="d-grid gap-2 d-md-flex justify-content-md-start">
                    <button type="submit" class="btn btn-primary btn-lg me-md-2">
                        <i class="bi bi-save"></i> Save Changes
                    </button>
                    <a asp-action="MyApartments" class="btn btn-secondary btn-lg">Cancel</a>
                </div>
            </form>
        </div>
    </div>
</div>

    
    @section Scripts {
    <partial name="_ValidationScriptsPartial" />
    
    <script>
        let addressMap, addressMarker;
        let searchTimeout;

        document.addEventListener('DOMContentLoaded', function() {
            if (typeof L === 'undefined') return console.error('Leaflet missing');

            addressMap = L.map('addressMap').setView([41.311, 69.241], 12);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(addressMap);
            
            addressMarker = L.marker([41.311, 69.241], { draggable: true }).addTo(addressMap);
            
            addressMap.on('click', e => {
                addressMarker.setLatLng(e.latlng);
                reverseGeocode(e.latlng.lat, e.latlng.lng);
            });
            
            addressMarker.on('dragend', e => {
                const latlng = e.target.getLatLng();
                reverseGeocode(latlng.lat, latlng.lng);
            });

            // ✅ Ручной ввод → автопоиск
            const streetField = document.getElementById('StreetAddress');
            const districtField = document.getElementById('District');
            
            streetField.addEventListener('blur', debounceSearch);
            districtField.addEventListener('blur', debounceSearch);
        });

        function debounceSearch() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(searchAddressFields, 1000);
        }

        function searchAddressFields() {
            const street = document.getElementById('StreetAddress').value.trim();
            const district = document.getElementById('District').value.trim();
            let query = '';
            
            if (street) query += street;
            if (district) query += `, ${district}`;
            query += ', Tashkent';
            
            if (query.length > 5) geocodeAddress(query);
        }

        // Поиск Enter
        document.getElementById('addressSearch').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') geocodeAddress(this.value);
        });

        async function geocodeAddress(query) {
            try {

                const res = await fetch(`/api/http/search?str=${encodeURIComponent(query)}`);
               // const res = await fetch(
                //    `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=3&countrycodes=UZ&accept-language=ru,en`
               // );
                const data = await res.json();
                
                if (data[0] && addressMap) {
                    const lat = parseFloat(data[0].lat);
                    const lng = parseFloat(data[0].lon);
                    
                    addressMap.setView([lat, lng], 16);
                    addressMarker.setLatLng([lat, lng]);
                    
                    document.getElementById('latitude').value = lat.toFixed(6);
                    document.getElementById('longitude').value = lng.toFixed(6);
                    
                    // Обновляем поля
                    if (data[0].address.road) {
                        document.getElementById('StreetAddress').value = data[0].address.road;
                    }
                    if (data[0].address.suburb || data[0].address.neighbourhood) {
                        document.getElementById('District').value = data[0].address.suburb || data[0].address.neighbourhood;
                    }
                }
            } catch(e) {
                console.error('Geocode failed:', e);
            }
        }

                 async function reverseGeocode(lat, lng) {
            try {
                const response = await fetch(`/api/http/reverse?lat=${lat}&lon=${lng}`);
               // const response = await fetch(
             //       `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1&accept-language=ru,en`
              //  );
                const data = await response.json();

                // ✅ Координаты
                document.getElementById('latitude').value = lat.toFixed(6);
                document.getElementById('longitude').value = lng.toFixed(6);

                // ✅ ВСЕ поля адреса
                const streetField = document.getElementById('StreetAddress');
                const buildingField = document.getElementById('BuildingNumber');
                const districtField = document.getElementById('District');
                const cityField = document.getElementById('City');
                const regionField = document.getElementById('Region');

                // Street (улица/проспект)
                streetField.value = data.address?.road ||
                                   data.address?.pedestrian ||
                                   data.address?.residential || '';

                // District (район)
                districtField.value = data.address?.suburb ||
                                     data.address?.neighbourhood ||
                                     data.address?.district || '';

                // City (город)
                cityField.value = data.address?.city ||
                                 data.address?.town ||
                                 data.address?.municipality || 'Tashkent';

                // Region (область)
                regionField.value = data.address?.state ||
                                   data.address?.region ||
                                   data.address?.["ISO3166-2-lvl4"] || 'Tashkent';

                // Building (если есть)
                if (data.address?.house_number) {
                    buildingField.value = data.address.house_number;
                }

                // ✅ Визуал
                [streetField, districtField, cityField, regionField].forEach(field => {
                    if (field.value) {
                        field.classList.add('border-success');
                        setTimeout(() => field.classList.remove('border-success'), 1500);
                    }
                });

                console.log('🗺️ Полный адрес:', data.display_name);

            } catch(error) {
                console.error('Reverse geocoding failed:', error);
            }
        }


        // Фото превью
        document.getElementById('photoInput')?.addEventListener('change', e => {
            const preview = document.getElementById('photoPreview');
            preview.innerHTML = '';
            Array.from(e.target.files).slice(0,10).forEach(file => {
                const reader = new FileReader();
                reader.onload = ev => {
                    preview.innerHTML += `<div class="col-md-3 mb-2"><img src="${ev.target.result}" class="img-thumbnail w-100" style="height:120px"></div>`;
                };
                reader.readAsDataURL(file);
            });
        });
    </script>
}

