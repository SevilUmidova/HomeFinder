@model HomeFinder.Models.ApartmentViewModel
@{
    ViewData["Title"] = "Add apartment";
}

<div class="container mt-4">
    <div class="row">
        <div class="col-md-8">
            <h2>Add New Apartment</h2>

            <form asp-action="Create" asp-controller="Apartments" method="post" enctype="multipart/form-data">
                @Html.AntiForgeryToken()

                <!-- ABOUT -->
                <fieldset class="border p-3 mb-4">
                    <legend class="w-auto px-2">About</legend>
                    <div class="mb-3">
                        <label asp-for="Description" class="form-label"></label>
                        <textarea asp-for="Description" class="form-control" rows="4" placeholder="Describe your apartment..."></textarea>
                        <span asp-validation-for="Description" class="text-danger"></span>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="Price" class="form-label"></label>
                                <input asp-for="Price" type="number" class="form-control" placeholder="5000000" min="0" />
                                <span asp-validation-for="Price" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="Size" class="form-label"></label>
                                <input asp-for="Size" type="number" class="form-control" placeholder="35" min="1" step="0.1" required />
                                <span asp-validation-for="Size" class="text-danger"></span>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label asp-for="Rooms" class="form-label"></label>
                        <input asp-for="Rooms" type="number" class="form-control" placeholder="2" min="1" step="1" required />
                        <span asp-validation-for="Rooms" class="text-danger"></span>
                    </div>
                    <div class="mb-3">
                        <label asp-for="ApartmentNumber" class="form-label"></label>
                        <input asp-for="ApartmentNumber" class="form-control" placeholder="42" />
                        <span asp-validation-for="ApartmentNumber" class="text-danger"></span>
                    </div>
                    <div class="mb-3">
                        <label asp-for="PhoneNumber" class="form-label"></label>
                        <input asp-for="PhoneNumber" type="tel" class="form-control" placeholder="+998 (90) 123-45-67" required />
                        <span asp-validation-for="PhoneNumber" class="text-danger"></span>
                    </div>
                </fieldset>

                <!-- 📍 ADDRESS + MAP -->
                <fieldset class="border p-3 mb-4">
                    <legend class="w-auto px-2">📍 Address & Location</legend>
                    <div class="mb-3">
                        <label class="form-label">🔍 Search address</label>
                        <input type="text" id="addressSearch" class="form-control" placeholder="Amir Temur st, Tashkent..." />
                        <small class="form-text text-muted">Enter или кликни на карту</small>
                    </div>
                    <div id="addressMap" style="height: 350px; border: 2px solid #dee2e6; border-radius: 0.375rem; margin-bottom: 1rem;"></div>

                    <!-- Скрытые координаты -->
                    <input type="hidden" asp-for="Latitude" id="latitude" />
                    <input type="hidden" asp-for="Longitude" id="longitude" />

                    <!-- Адрес -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="StreetAddress" class="form-label"></label>
                                <input asp-for="StreetAddress" class="form-control" />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="BuildingNumber" class="form-label"></label>
                                <input asp-for="BuildingNumber" class="form-control" required /> <!-- ✅ Активно -->
                                <span asp-validation-for="BuildingNumber" class="text-danger"></span>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="District" class="form-label"></label>
                                <input asp-for="District" class="form-control" />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="City" class="form-label"></label>
                                <input asp-for="City" class="form-control" value="Tashkent" />
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label asp-for="Region" class="form-label"></label>
                        <input asp-for="Region" class="form-control" />
                        <span asp-validation-for="Region" class="text-danger"></span>
                    </div>
                </fieldset>

                <!-- PHOTOS -->
                <fieldset class="border p-3 mb-4">
                    <legend class="w-auto px-2">Photos</legend>
                    <div class="mb-3">
                        <label for="photoInput" class="form-label">Upload photos</label>
                        <input type="file"
                               id="photoInput"
                               name="Photos"
                               multiple
                               accept=".jpg,.jpeg,.png"
                               class="form-control" />
                        <div class="form-text">JPG, PNG | Max 5MB per file | Multiple OK</div>
                    </div>
                    <div id="photoPreview" class="row g-2"></div>
                </fieldset>

                <div class="d-grid gap-2 d-md-flex justify-content-md-start">
                    <button type="submit" class="btn btn-success btn-lg me-md-2">✅ Save</button>
                    <a asp-action="MyApartments" class="btn btn-secondary btn-lg">❌ Cancel</a>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        // Ждём полной загрузки DOM + Leaflet
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof L === 'undefined') {
                console.error('Leaflet not loaded!');
                return;
            }

            let addressMap, addressMarker;

            // Карта
            addressMap = L.map('addressMap').setView([41.311, 69.241], 12);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap'
            }).addTo(addressMap);

            addressMarker = L.marker([41.311, 69.241], { draggable: true }).addTo(addressMap);

            addressMap.on('click', function(e) {
                addressMarker.setLatLng(e.latlng);
                reverseGeocode(e.latlng.lat, e.latlng.lng);
            });

            addressMarker.on('dragend', function(e) {
                const latlng = e.target.getLatLng();
                reverseGeocode(latlng.lat, latlng.lng);
            });
        });

        // Поиск
        document.getElementById('addressSearch').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                geocodeAddress(this.value);
            }
        });

        async function geocodeAddress(query) {
            try {
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1&countrycodes=UZ`
                );
                const data = await response.json();

                if (data[0]) {
                    const lat = parseFloat(data[0].lat);
                    const lng = parseFloat(data[0].lon);

                    if (addressMap) {
                        addressMap.setView([lat, lng], 16);
                        addressMarker.setLatLng([lat, lng]);
                    }

                    document.getElementById('latitude').value = lat.toFixed(6);
                    document.getElementById('longitude').value = lng.toFixed(6);
                    document.getElementById('StreetAddress').value = data[0].display_name.split(',')[0].trim();
                    document.getElementById('District').value = data[0].address.suburb || data[0].address.neighbourhood || '';
                }
            } catch (error) {
                console.error('Geocoding failed:', error);
            }
        }

            async function reverseGeocode(lat, lng) {
            try {
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1&accept-language=ru,en`
                );
                const data = await response.json();

                // ✅ Координаты
                document.getElementById('latitude').value = lat.toFixed(6);
                document.getElementById('longitude').value = lng.toFixed(6);

                // ✅ ВСЕ поля адреса
                const streetField = document.getElementById('StreetAddress');
                const buildingField = document.getElementById('BuildingNumber');
                const districtField = document.getElementById('District');
                const cityField = document.getElementById('City');
                const regionField = document.getElementById('Region');

                // Street (улица/проспект)
                streetField.value = data.address?.road ||
                                   data.address?.pedestrian ||
                                   data.address?.residential || '';

                // District (район)
                districtField.value = data.address?.suburb ||
                                     data.address?.neighbourhood ||
                                     data.address?.district || '';

                // City (город)
                cityField.value = data.address?.city ||
                                 data.address?.town ||
                                 data.address?.municipality || 'Tashkent';

                // Region (область)
                regionField.value = data.address?.state ||
                                   data.address?.region ||
                                   data.address?.["ISO3166-2-lvl4"] || 'Tashkent';

                // Building (если есть)
                if (data.address?.house_number) {
                    buildingField.value = data.address.house_number;
                }

                // ✅ Визуал
                [streetField, districtField, cityField, regionField].forEach(field => {
                    if (field.value) {
                        field.classList.add('border-success');
                        setTimeout(() => field.classList.remove('border-success'), 1500);
                    }
                });

                console.log('🗺️ Полный адрес:', data.display_name);

            } catch(error) {
                console.error('Reverse geocoding failed:', error);
            }
        }

        // Фото превью (НАДЁЖНЫЙ)
        document.addEventListener('DOMContentLoaded', function() {
            const photoInput = document.getElementById('photoInput');
            const photoPreview = document.getElementById('photoPreview');

            if (photoInput) {
                photoInput.addEventListener('change', function(e) {
                    photoPreview.innerHTML = '';

                    Array.from(e.target.files).slice(0, 10).forEach((file, index) => {
                        if (file.size > 5 * 1024 * 1024) {
                            photoPreview.innerHTML += `<div class="col-12 text-danger">❌ ${file.name} слишком большой</div>`;
                            return;
                        }

                        const reader = new FileReader();
                        reader.onload = function(ev) {
                            const col = document.createElement('div');
                            col.className = 'col-md-3 mb-2';
                            col.innerHTML = `
                                <div class="position-relative">
                                    <img src="${ev.target.result}" class="img-thumbnail w-100" style="height: 120px; object-fit: cover;">
                                    <small class="d-block mt-1 text-truncate">${file.name}</small>
                                </div>`;
                            photoPreview.appendChild(col);
                        };
                        reader.readAsDataURL(file);
                    });
                });
            }
        });
    </script>
}