@model HomeFinder.Models.Reports.MostViewedApartmentsReportVm

@{
    ViewData["Title"] = "Most viewed apartments";
}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" />

<div class="container py-4">
    <div class="d-flex align-items-center justify-content-between mb-3">
        <div>
            <h2 class="mb-1">üî• Most viewed apartments</h2>
            <div id="reportPeriod" class="text-muted">
                –¢–æ–ø @Model.Top –ø–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞–º (—Å @Model.DateFrom.ToString("dd.MM.yyyy") –ø–æ @Model.DateTo.ToString("dd.MM.yyyy"))
            </div>
        </div>
        <a class="btn btn-outline-secondary" asp-action="Index">‚Üê Back</a>
    </div>

    <div class="card shadow-sm mb-3">
        <div class="card-body d-flex flex-wrap align-items-end gap-2">
            <div>
                <label for="topInput" class="form-label mb-1">Top</label>
                <input id="topInput" name="top" type="number" class="form-control form-control-sm" value="@Model.Top" min="1" max="50" style="width:100px;" />
            </div>
            <div>
                <label for="dateFrom" class="form-label mb-1">–û—Ç</label>
                <input id="dateFrom" name="dateFrom" type="text" class="form-control form-control-sm" value="@Model.DateFrom.ToString("dd.MM.yyyy")" placeholder="–¥–¥.–º–º.–≥–≥–≥–≥" style="width:140px;" autocomplete="off" />
            </div>
            <div>
                <label for="dateTo" class="form-label mb-1">–î–æ</label>
                <input id="dateTo" name="dateTo" type="text" class="form-control form-control-sm" value="@Model.DateTo.ToString("dd.MM.yyyy")" placeholder="–¥–¥.–º–º.–≥–≥–≥–≥" style="width:140px;" autocomplete="off" />
            </div>
            <div>
                <button id="applyBtn" class="btn btn-primary btn-sm" type="button">Apply</button>
            </div>
            <div id="reportError" class="text-danger small ms-2 d-none"></div>
        </div>
    </div>

    <div class="row g-3">
        <div class="col-lg-7">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h5 class="mb-2">Chart</h5>
                    <div id="reportData">
                        @await Html.PartialAsync("_MostViewedApartmentsData", Model)
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-5">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h5 class="mb-3">Table</h5>
                    <div id="reportTable">
                        @await Html.PartialAsync("_MostViewedApartmentsTable", Model)
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ru.js"></script>

    <script>
        let viewsChartInstance = null;

        function setError(message) {
            const errorEl = document.getElementById('reportError');
            if (!errorEl) return;
            if (!message) {
                errorEl.classList.add('d-none');
                errorEl.textContent = '';
                return;
            }
            errorEl.textContent = message;
            errorEl.classList.remove('d-none');
        }

        function parseRuDate(value) {
            if (!value) return null;
            const m = value.trim().match(/^(\d{2})\.(\d{2})\.(\d{4})$/);
            if (!m) return null;
            const day = Number(m[1]);
            const month = Number(m[2]) - 1;
            const year = Number(m[3]);
            const d = new Date(year, month, day);
            if (d.getFullYear() !== year || d.getMonth() !== month || d.getDate() !== day) return null;
            return d;
        }

        function formatRuDate(date) {
            const dd = String(date.getDate()).padStart(2, '0');
            const mm = String(date.getMonth() + 1).padStart(2, '0');
            const yyyy = date.getFullYear();
            return `${dd}.${mm}.${yyyy}`;
        }

        function buildLabelsAndData(items) {
            const labels = [];
            const data = [];

            for (let i = 0; i < items.length; i++) {
                const x = items[i];
                let label = "#" + x.apartmentId;
                if (x.district && x.district.trim() !== "") label += " ‚Ä¢ " + x.district;
                labels.push(label);
                data.push(x.views || 0);
            }

            return { labels, data };
        }

        function renderChartFromJsonText(jsonText) {
            const canvas = document.getElementById('viewsChart');
            if (!canvas || !jsonText) return;

            let payload;
            try {
                payload = JSON.parse(jsonText);
            } catch {
                return;
            }

            const items = payload.items || [];
            const { labels, data } = buildLabelsAndData(items);

            if (viewsChartInstance) {
                viewsChartInstance.destroy();
                viewsChartInstance = null;
            }

            viewsChartInstance = new Chart(canvas, {
                type: 'bar',
                data: {
                    labels,
                    datasets: [{
                        label: 'Views',
                        data,
                        borderWidth: 1,
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true, ticks: { precision: 0 } } }
                }
            });
        }

        function updatePeriodLabel(top, fromText, toText) {
            const periodEl = document.getElementById('reportPeriod');
            if (!periodEl) return;
            periodEl.textContent = `–¢–æ–ø ${top} –ø–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞–º (—Å ${fromText} –ø–æ ${toText})`;
        }

        async function reloadReport() {
            setError('');

            const topEl = document.getElementById('topInput');
            const dfEl = document.getElementById('dateFrom');
            const dtEl = document.getElementById('dateTo');

            const topValue = Number(topEl?.value || 5);
            const top = Number.isFinite(topValue) ? Math.min(50, Math.max(1, topValue)) : 5;
            if (topEl) topEl.value = String(top);

            const fromText = (dfEl?.value || '').trim();
            const toText = (dtEl?.value || '').trim();
            const fromDate = parseRuDate(fromText);
            const toDate = parseRuDate(toText);

            if (!fromDate || !toDate) {
                setError('–í–≤–µ–¥–∏—Ç–µ –¥–∞—Ç—ã –≤ —Ñ–æ—Ä–º–∞—Ç–µ dd.MM.yyyy.');
                return;
            }

            if (fromDate > toDate) {
                setError('–î–∞—Ç–∞ "–û—Ç" –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –±–æ–ª—å—à–µ –¥–∞—Ç—ã "–î–æ".');
                return;
            }

            const url = `/Report/MostViewedApartmentsData?top=${encodeURIComponent(top)}&dateFrom=${encodeURIComponent(fromText)}&dateTo=${encodeURIComponent(toText)}`;
            const resp = await fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
            if (!resp.ok) {
                setError('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –æ—Ç—á—ë—Ç–∞.');
                return;
            }

            const html = await resp.text();
            const temp = document.createElement('div');
            temp.innerHTML = html;

            const chartBlock = temp.querySelector('#chartBlock');
            const jsonBlock = temp.querySelector('#jsonBlock');
            const tableBlock = temp.querySelector('#tableBlock');

            if (!chartBlock || !jsonBlock || !tableBlock) {
                setError('–ü–æ–ª—É—á–µ–Ω –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞.');
                return;
            }

            const reportData = document.getElementById('reportData');
            const reportTable = document.getElementById('reportTable');
            if (!reportData || !reportTable) {
                setError('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ.');
                return;
            }

            reportData.innerHTML = chartBlock.outerHTML + jsonBlock.outerHTML;
            reportTable.innerHTML = tableBlock.innerHTML;

            updatePeriodLabel(top, fromText, toText);
            renderChartFromJsonText(document.getElementById('jsonBlock')?.textContent?.trim() || '');
        }

        const applyBtn = document.getElementById('applyBtn');
        if (applyBtn) applyBtn.addEventListener('click', reloadReport);

        flatpickr("#dateFrom", {
            dateFormat: "d.m.Y",
            allowInput: true,
            disableMobile: true,
            locale: (window.flatpickr && window.flatpickr.l10ns && window.flatpickr.l10ns.ru) ? window.flatpickr.l10ns.ru : undefined
        });

        flatpickr("#dateTo", {
            dateFormat: "d.m.Y",
            allowInput: true,
            disableMobile: true,
            locale: (window.flatpickr && window.flatpickr.l10ns && window.flatpickr.l10ns.ru) ? window.flatpickr.l10ns.ru : undefined
        });

        renderChartFromJsonText(document.getElementById('jsonBlock')?.textContent?.trim() || '');
    </script>
}