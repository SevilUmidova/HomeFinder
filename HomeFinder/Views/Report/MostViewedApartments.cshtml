@model HomeFinder.Models.Reports.MostViewedApartmentsReportVm

@{
    ViewData["Title"] = "Most viewed apartments";
}

<div class="container py-4">
    <div class="d-flex align-items-center justify-content-between mb-3">
        <div>
            <h2 class="mb-1">üî• Most viewed apartments</h2>
            <div class="text-muted">
                –¢–æ–ø @Model.Top –ø–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞–º (—Å @Model.DateFrom.ToString("dd.MM.yyyy") –ø–æ @Model.DateTo.ToString("dd.MM.yyyy"))
            </div>
        </div>
        <a class="btn btn-outline-secondary" asp-action="Index">‚Üê Back</a>
    </div>

    <form method="get" asp-action="MostViewedApartments" class="card shadow-sm mb-3">
        <div class="card-body d-flex flex-wrap align-items-end gap-2">
            <div>
                <label for="topInput" class="form-label mb-1">Top</label>
                <input id="topInput" name="top" type="number" class="form-control form-control-sm" value="@Model.Top" min="1" max="50" style="width:100px;" />
            </div>
            <div>
                <label for="dateFrom" class="form-label mb-1">–û—Ç</label>
                <input id="dateFrom" name="dateFrom" type="text" class="form-control form-control-sm" value="@Model.DateFrom.ToString("dd.MM.yyyy")" placeholder="–¥–¥.–º–º.–≥–≥–≥–≥" style="width:140px;" autocomplete="off" />
            </div>
            <div>
                <label for="dateTo" class="form-label mb-1">–î–æ</label>
                <input id="dateTo" name="dateTo" type="text" class="form-control form-control-sm" value="@Model.DateTo.ToString("dd.MM.yyyy")" placeholder="–¥–¥.–º–º.–≥–≥–≥–≥" style="width:140px;" autocomplete="off" />
            </div>
            <div>
                <button id="applyBtn" class="btn btn-primary btn-sm" type="submit">Apply</button>
            </div>
        </div>
    </form>

    <div class="row g-3">
        <div class="col-lg-7">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h5 class="mb-2">Chart</h5>
                    @await Html.PartialAsync("_MostViewedApartmentsData", Model)
                </div>
            </div>
        </div>

        <div class="col-lg-5">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h5 class="mb-3">Table</h5>
                    @await Html.PartialAsync("_MostViewedApartmentsTable", Model)
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    <script>
        (function () {
            const jsonText = document.getElementById('jsonBlock')?.textContent?.trim();
            const canvas = document.getElementById('viewsChart');
            if (!jsonText || !canvas) return;

            let payload;
            try {
                payload = JSON.parse(jsonText);
            } catch {
                return;
            }

            const items = payload.items || [];
            const labels = [];
            const data = [];
            for (let i = 0; i < items.length; i++) {
                const x = items[i];
                let label = "#" + x.apartmentId;
                if (x.district && x.district.trim() !== "") label += " ‚Ä¢ " + x.district;
                labels.push(label);
                data.push(x.views || 0);
            }

            new Chart(canvas, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Views',
                        data: data,
                        borderWidth: 1,
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true, ticks: { precision: 0 } } }
                }
            });
        })();

        flatpickr("#dateFrom", {
            dateFormat: "d.m.Y",
            allowInput: true
        });

        flatpickr("#dateTo", {
            dateFormat: "d.m.Y",
            allowInput: true
        });
    </script>
}